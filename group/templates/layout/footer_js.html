<!-- Core JS -->
<!-- build:js assets/vendor/js/core.js -->
<script src="{{ url_for('static', filename='assets/vendor/libs/jquery/jquery.js') }}"></script>
<script src="{{ url_for('static', filename='assets/vendor/libs/popper/popper.js') }}"></script>
<script src="{{ url_for('static', filename='assets/vendor/js/bootstrap.js') }}"></script>
<script src="{{ url_for('static', filename='assets/vendor/libs/perfect-scrollbar/perfect-scrollbar.js') }}"></script>
<script src="{{ url_for('static', filename='assets/vendor/js/menu.js') }}"></script>
<!-- endbuild -->
<!-- Vendors JS -->
<script src="{{ url_for('static', filename='assets/vendor/libs/apex-charts/apexcharts.js') }}"></script>
<script src="{{ url_for('static', filename='assets/js/chartjs.js') }}"></script>
<!-- Main JS -->
<script src="{{ url_for('static', filename='assets/js/main.js') }}"></script>
<script src="{{ url_for('static', filename='assets/js/charts-chartjs.js') }}"></script>
<!-- Page JS -->
<script src="{{ url_for('static', filename='assets/js/dashboards-analytics.js') }}"></script>
<!-- Data Tables -->
<script src="https://cdn.datatables.net/1.13.5/js/jquery.dataTables.min.js"  crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdn.datatables.net/1.13.5/js/dataTables.bootstrap4.min.js"  crossorigin="anonymous" referrerpolicy="no-referrer"></script>


<div class="modal fade" id="logmodal" tabindex="-1" role="dialog" aria-labelledby="logmodalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="logmodalLabel">Status</h5>
          <div id="spinner" style="float: right; margin-right: -50%;"></div>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close" onClick="redirection();">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body" id="run-time-body">
            <pre id="run-time-logs"></pre>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal" onClick="redirection();" >Close</button>
        </div>
      </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.js"></script>
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>

{% if rack_data %}
    {% for rack, devices in rack_data.items %}
        <script>
            $(function(){
                $("#{{ rack }}").sortable({connectWith: ".connectedSortable"}).disableSelection();
            });
        </script>
        {% for device in devices %}
            <script>
                $("#{{ device }}").draggable({ revert: "invalid" });
            </script>
        {% endfor %}
    {% endfor %}
{% endif %}
    

<script type="text/javascript" src="{{ url_for('static', filename='assets/js/wmks.min.js') }}"></script> sd
<script>
    /*
    * TODO
    * This perticular piece of code is written as a POC of WKMS.
    * In this section first section is a ajax call which will retrive the ticket id from the vcenter.
    * Other WKMS section will open the VM Machine console here.
    * Ajax Section will not work anyways. Need to implement the SDK to use it further. It is written just for the knowledge purpose.
    * If this logic will require, then only need to work on this.
    * Example:
    * https://vcenter.taurusgroup.one/ui/webconsole.html?
    * vmId=vm-21059&
    * vmName=demo-node007&
    * numMksConnections=0&
    * serverGuid=0bb48edd-894a-4b8b-ae3d-48d954f383f1&
    * locale=en-US
    */

    /*$.ajax({
        url: "https://vcenter.taurusgroup.one/mob/?moid=vm-21059&method=acquireTicket",
        type: 'POST',
        data: {"moid": "vm-21059", "method": "acquireTicket"},
        dataType: 'json',
        success: function(data) {
            console.log(data);
        },
        error: function(data) {
            console.log(data);
        }
    });*/
    /*var wmks = WMKS.createWMKS("wmksContainer",{})
        .register(WMKS.CONST.Events.CONNECTION_STATE_CHANGE, function(event,data){
        if(data.state == WMKS.CONST.ConnectionState.CONNECTED){
            console.log("connection state change : connected");}
        });
    //wmks.connect("wss://ESXi.host.IP.Address:443/ticket/webmksTicket"); 
    wmks.connect("wss://plundervolt.taurusgroup.one:443/ticket/de55ac40686b3c05");*/
</script> 



{% if dataset %}
<script>
    ! function(){
        let i, n, d, s, c; 
        document.querySelectorAll(".chartjs").forEach(function(o){ o.height = o.dataset.height });
        var isRtl = true;
        var p = document.getElementById("lineChart"),
        p = (p && new Chart(p, {
            type: "line",
            data: {
                labels: {{ labels | safe }},
                datasets: [{{ dataset  | safe  }}],
            },
            options: {
                responsive: !0,
                maintainAspectRatio: !1,
                scales: {
                    x: {grid: {color: s, drawBorder: !1, borderColor: s}, ticks: {color: d} },
                    y: {scaleLabel: {display: !0}, min: 0, max: 100, ticks: {color: d, stepSize: 20}, grid: {color: s, drawBorder: !1, borderColor: s} }
                },
                plugins: {
                    tooltip: {rtl: isRtl, backgroundColor: i, titleColor: n, bodyColor: c, borderWidth: 1, borderColor: s},
                    legend: {position: "top", align: "start", rtl: isRtl, labels: {usePointStyle: !0, padding: 35, boxWidth: 6, boxHeight: 6, color: c} }
                }
            }
        })) 
    }();

</script>
{% endif %}


<script>
    $('.on').click(function(){
        $(this).parent().parent().css("background-color", '#3cba5d');
    });
    $('.off').click(function(){
        $(this).parent().parent().css("background-color", '#d41717');
        });
    $('.reboot').click(function(){
        $(this).parent().parent().css("background-color", '#ebc315');
    });
</script>

<script>
    function get_image_info(){
        var osimage = $('#id_name').val();
        if  (osimage.length){
            $.ajax({
                url: "/get_record/osimage/"+osimage+"/",
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    $('#id_initrdfile').val('');
                    $('#id_kernelfile').val('');
                    $('#id_kernelversion').val('');
                    if (data.initrdfile && data.initrdfile != 'None'){ $('#id_initrdfile').val(data.initrdfile); }
                    if (data.kernelfile && data.kernelfile != 'None'){ $('#id_kernelfile').val(data.kernelfile); }
                    if (data.kernelversion && data.kernelversion != 'None'){ $('#id_kernelversion').val(data.kernelversion); }
                }
            });
        }
    }
</script>

<script>
 

    new DataTable('.datatable');
    $('#datatable_length  lable').addClass("datatable_length").parent().next().addClass("datatable_length");
    $('#datatable_length  select').addClass("datatable_length").parent().next().addClass("datatable_length");
    $('.dataTables_filter').addClass("datatable_search").parent().next().addClass("datatable_search");
    $('.dataTables_filter lable').addClass("datatable_length").parent().next().addClass("datatable_length");
    $('.dataTables_filter input').addClass("datatable_length").parent().next().addClass("datatable_length");
    $(".dataTables_filter ").after("<br />");
    $('.dataTables_paginate').addClass("datatable_paginate").parent().next().addClass("datatable_paginate");



    function color_status(message=null){
        if (message.includes('ON')){
            message = "<strong style='color:green;'>" + message + "</strong>";
        } else if (message.includes('OFF')){
            message =  "<strong style='color:yellow;'>" + message + "</strong>";
        } else {
            message = "<strong style='color:red;'>" + message + "</strong>";
        }
        return message
    }
    

    function create_row(count, node, status, power){
        if (power == true){
            row = '<tr>';
            row += '<td style="padding-left: 1em; padding-right: 1em; text-align: center; vertical-align: top;"><input type="checkbox" name="node" value="'+node+'"  id="'+count+'" /></td>';
            row += '<td style="padding-left: 1em; padding-right: 1em; text-align: center; vertical-align: top;">'+count+'</td>';
            row += '<td style="padding-left: 1em; padding-right: 1em; text-align: center; vertical-align: top;">'+node+'</td>';
            row += '<td style="padding-left: 1em; padding-right: 1em; text-align: center; vertical-align: top;">'+color_status(status)+'</td>';
            row +='<td style="padding-left: 1em; padding-right: 1em; text-align: center; vertical-align: top;"><a id="actions" href="/power/status/'+node+'" data-bs-toggle="tooltip" data-bs-offset="0,4" data-bs-placement="top" data-bs-html="true" data-bs-original-title="<i class=\'bx bxs-arrow-from-left bx-xs\' ></i> <span>Current Status of '+node+'</span>"><i class="bx bx-md bx-stats" style="color: #03c3ec;"></i></a>&nbsp;<a id="actions" href="/power/on/'+node+'" data-bs-toggle="tooltip" data-bs-offset="0,4" data-bs-placement="top" data-bs-html="true" data-bs-original-title="<i class=\'bx bxs-arrow-from-left bx-xs\' ></i> <span>Power ON '+node+'</span>"><i class="bx bx-md bx-power-off" style="color: #71dd37;"></i></a>&nbsp;<a id="actions" href="/power/off/'+node+'" data-bs-toggle="tooltip" data-bs-offset="0,4" data-bs-placement="top" data-bs-html="true" data-bs-original-title="<i class=\'bx bxs-arrow-from-left bx-xs\' ></i> <span>Power OFF '+node+'</span>"><i class="bx bx-md bx-power-off bx-flip-vertical" style="color: #ff3e1d;"></i></a>';
            row += '</tr>';
        } else {
            row = '<tr>';
            row += '<td style="padding-left: 1em; padding-right: 1em; text-align: center; vertical-align: top;">'+count+'</td>';
            row += '<td style="padding-left: 1em; padding-right: 1em; text-align: center; vertical-align: top;">'+node+'</td>';
            row += '<td style="padding-left: 1em; padding-right: 1em; text-align: center; vertical-align: top;">'+color_status(status)+'</td>';
            row += '</tr>';
        }
        return row
    }




    function color_message(message=null){
        if  (message.includes('error') || message.includes('undefined') || message.includes('failed')){
            message = "<span style='color:red;'>" + message + "</span><br />";
        } else {
            message = "<span style='color:yellow;'>" + message + "</span><br />";
        }
        return message
    }



    function redirection(){
        if  (window.location.pathname.includes('/clone/')){
            redirect_path = window.location.pathname;
            redirect_path = redirect_path.replace('/clone/', '/edit/');
            window.location.href = redirect_path;
        } else if  (window.location.pathname.includes('/osgrab/') || window.location.pathname.includes('/ospush/')){
            redirect_path = window.location.pathname;
            window.location.href = redirect_path;
        } else if  (window.location.pathname.includes('/service/')){
            window.location.href = window.location.href;
        } else {
            $('#logmodal').modal('hide');
        }
    }


    function clone_osimage(request_id=null, message=null){
        $('#run-time-logs').empty();
        message = decodeURI(message);
        $(window).on('load', function() {
            $('#logmodal').modal('show');
        });
        var text = $('#run-time-logs').html();
        text += color_message(message);
        $('#run-time-logs').html(text);
        var run_time_div = document.getElementById("run-time-body");

        var url = window.location.href
        url = url.replace(window.location.search,'');
        url = url.split('/');
        url.pop();
        url.pop();
        url = url.join("/");
        url = url+"/check_status/config/status/"+request_id;

        var intervalId;
        intervalId = setInterval(function(){
            $.getJSON(url, function(data){
                if (data.message.includes("No data for this request")){
                    clearInterval(intervalId);
                } else {
                    text = $('#run-time-logs').html();
                    if  (data.message.length){
                        if  (data.message.includes(';;')){
                            const myArray = data.message.split(";;");
                            for (var i=0; i<myArray.length; i++) { text += color_message(myArray[i]); }
                        } else {
                            text += color_message(data.message);
                        }
                        $('#run-time-logs').html(text);
                    }
                    run_time_div.scrollTop = run_time_div.scrollHeight;
                }
            });
        }, 1000);
    }

    function member(table=null, record=null){
        $('#logmodalLabel').empty();
        $('#logmodalLabel').html('<span>Member Nodes Of '+table+' >> '+record+' </span>');
        $('#run-time-logs').empty();
        $.ajax({
            url: window.location.href+"/member/"+table+"/"+record,
            type: 'GET',
            contentType: 'application/json; charset=UTF-8',
            dataType: 'json',
            success: function(request_data) {
                $('#logmodal').modal('show');
                var text = $('#run-time-logs').text();
                text += color_message(request_data);
                $('#run-time-logs').html(text);
            }
        });
    }


    function check_request_id(){
        var query_string = window.location.search;
        if (query_string.includes("request_id") && query_string.includes("message")){
            
            var query_string = query_string.substr(1).split('&');
            var params = {};
            for (var i = 0; i < query_string.length; i++) {
                var parts = query_string[i].split('=');
                params[parts[0]] = parts[1];
            }
            clone_osimage(params.request_id, params.message);
        }
    }

    check_request_id();


    function pack_osimage(osimage=null){
        if  (osimage){
            var osimage = osimage
        } else {
            var form_data = $('form').serialize();
            var osimage = form_data.replace(/osimage=/g,'');
        }
        $('#logmodalLabel').empty();
        $('#logmodalLabel').html('<span>Packing OS Image >> '+osimage+'...</span>');
        spinner = '<div class="spinner-border spinner-border-lg text-primary" role="status"><span class="visually-hidden">Loading...</span></div>';
        $('#spinner').empty();
        $('#spinner').html(spinner);
        $('#run-time-logs').empty();
        if  (osimage.length){
            $.ajax({
                url: "/get_request/osimage/"+osimage+"/_pack/",
                type: 'GET',
                success: function(request_data) {
                    $('#logmodal').modal('show');
                    var text = $('#run-time-logs').html();
                    text += color_message(request_data.message);
                    $('#run-time-logs').html(text);
                    var run_time_div = document.getElementById("run-time-body");
                    var url = "/check_status/config/status/"+request_data.request_id+"/";
                    var intervalId;
                    intervalId = setInterval(function(){
                        $.get(url, function(data){
                            if (data.message.includes("No data for this request")){
                                $('#logmodalLabel').empty();
                                $('#spinner').empty();
                                $('#logmodalLabel').html('<span>OS Image Packed >> '+osimage+'...</span>');
                                clearInterval(intervalId);
                            } else {
                                text = $('#run-time-logs').html();
                                if  (data.message.length){
                                    if  (data.message.includes(';;')){
                                        const myArray = data.message.split(";;");
                                        for (var i=0; i<myArray.length; i++) {
                                            text += color_message(myArray[i]);
                                        }
                                    } else {
                                        text += color_message(data.message);
                                    }
                                    $('#run-time-logs').html(text);
                                }
                                run_time_div.scrollTop = run_time_div.scrollHeight;
                            }
                        });
                    }, 1000);
                }
            });
        
        } else {
            var error_message = "Kindly select an OS Image to pack..."
            $('#pack_alert').empty();
            $('#pack_alert').append(error_message);
            $('#pack_alert').show(); 
                
        }
        
    }
    
</script>

<script>

    function ucwords (str) {
        return (str + '').replace(/^([a-z])|\s+([a-z])/g, function ($1) {
            return $1.toUpperCase();
        });
    }

    function get_list(table, select){
        var network = '';
        $.ajax({
            async: false,
            global: false,
            url: "/get_list/"+table,
            type: 'GET',
            dataType: 'json',
            success: function(res) {
                network += '<span class="input-group-text">'+ucwords(table)+'</span><select name="'+table+'" class="form-control" id="id_'+table+'">';
                for (var i=0; i<res.length; i++) {
                    if (select == res[i][0]){
                        network += '<option value="'+res[i][0]+'" selected>'+res[i][1]+'</option>';
                    } else {
                        network += '<option value="'+res[i][0]+'">'+res[i][1]+'</option>';
                    }
                
                }
                network += '</select>';
            },
            //error: function() {
            //    alert('Error occured');
           // }
        });
        return network;
    }

    node_interface = '<br /><div class="input-group"><span class="input-group-text">Interface</span><input type="text" name="interface" class="form-control" placeholder="interface" /><span class="input-group-text">Ipaddress</span><input type="text" name="ipaddress" class="form-control ipv4" placeholder="ipaddress" /><span class="input-group-text">Macaddress</span><input type="text" name="macaddress" class="form-control mac" placeholder="macaddress" />'+get_list("network", null)+'<span class="input-group-text">Options</span><input type="text" name="options" class="form-control" placeholder="options" /><button type="button" class="btn btn-sm btn-danger" id="remove_nodeinterface">Remove Interface</button></div>'
    group_interface = '<br /><div class="input-group"><span class="input-group-text">Interface</span><input type="text" name="interface" class="form-control" placeholder="interface" />'+get_list("network", null)+'<span class="input-group-text">Options</span><input type="text" name="options" class="form-control" placeholder="options" /><button type="button" class="btn btn-sm btn-danger" id="remove_nodeinterface">Remove Interface</button></div>'
    $("#add_nodeinterface").click(function () {
        {% if 'Node' in table %}
            $("#nodeinterface").append(node_interface);
        {% elif 'Group' in table %}
            $("#nodeinterface").append(group_interface);    
        {% endif %}
     });
     $('body').on('click', '#remove_nodeinterface', function() {
        $(this).parent().prev().remove();
        $(this).parent().remove()
        
     });


    $('.network').each(function(i, obj) {
        $("#"+obj.id).after(get_list("network", obj.id));
    });
</script>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.inputmask/5.0.8/jquery.inputmask.min.js" integrity="sha512-efAcjYoYT0sXxQRtxGY37CKYmqsFVOIwMApaEbrxJr4RwqVVGw8o+Lfh/+59TU07+suZn1BWq4fDl5fdgyCNkw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
    function activate_inputmark(){
        var ipv4_address = $('.ipv4');
        ipv4_address.inputmask({
            alias: "ip",
            greedy: false
        });
        var mac_address = $('.mac');
        mac_address.inputmask({
            alias: "mac",
            greedy: false
        });
    }

    $('body').on('click', '#add_nodeinterface', function() {
        activate_inputmark();
    });

    activate_inputmark();
</script>
