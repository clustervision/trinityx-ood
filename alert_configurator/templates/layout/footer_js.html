<script src="{{ url_for('static', filename='js/jquery.js') }}"></script>
<script src="{{ url_for('static', filename='js/bootstrap.js') }}"></script>
<script src="{{ url_for('static', filename='js/main.js') }}"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.9/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.9/mode/javascript/javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/yaml/yaml.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>


<!-- jQuery -->


<script>
    function get_rules(){
        $.ajax({
            url: '/get_rules',
            type: 'GET',
            success: function(data) {
                    console.log(data);
                },
                error: function(xhr, status, error) {
                    console.error("Error fetching data:", error);
                    //alert("Failed to load configuration data.");
                }
            });
        }
    get_rules();



    $(document).ready(function() {
        let editor;
        let successToast = $('<div class="bs-toast toast toast-placement-ex m-2 fade bg-success top-0 end-0 show" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="2000"> \
            <div class="toast-header"> \
              <i class="bx bx-bell me-2"></i> \
              <div class="me-auto fw-medium">Configuration</div> \
              <small>0 seconds ago</small> \
              <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button> \
            </div> \
            <div class="toast-body">Configuration Saved successfully.</div> \
          </div>');

        let failedToast = $('<div class="bs-toast toast toast-placement-ex m-2 fade bg-danger top-0 end-0 show" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="2000"> \
            <div class="toast-header"> \
              <i class="bx bx-bell me-2"></i> \
              <div class="me-auto fw-medium">Configuration</div> \
              <small>0 seconds ago</small> \
              <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button> \
            </div> \
            <div class="toast-body"></div> \
          </div>');

        let warningToast = $('<div class="bs-toast toast toast-placement-ex m-2 fade bg-warning top-0 end-0 show" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="2000"> \
            <div class="toast-header"> \
              <i class="bx bx-bell me-2"></i> \
              <div class="me-auto fw-medium">Configuration</div> \
              <small>0 seconds ago</small> \
              <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button> \
            </div> \
            <div class="toast-body"></div> \
          </div>');

        $('#edit_configuration').click(function() {
            $.ajax({
                url: '/edit_config',
                type: 'GET',
                success: function(data) {
                    if (!editor) {
                        editor = CodeMirror(document.getElementById('jsonEditor'), {
                            mode: { name: "javascript", json: true },
                            theme: "material-darker",
                            lineNumbers: true,
                            autoCloseBrackets: true,
                            matchBrackets: true,
                            tabSize: 2,
                            lineWrapping: false,
                            viewportMargin: Infinity
                        });





                        // When switching to JSON mode, format the content as JSON
                        $('#jsonModeBtn').click(function() {
                            try {
                                let currentContent = editor.getValue();
                                let jsonData = jsyaml.load(currentContent); // Try parsing it as YAML
                                let formattedJson = JSON.stringify(jsonData, null, 2);
                                editor.setValue(formattedJson); // Set it back as formatted JSON
                            } catch (e) {
                                warningToast.find('.toast-body').text("Invalid YAML content:" + e);
                                $('body').append(warningToast);
                                warningToast.addClass('show');
                                setTimeout(function() {
                                    warningToast.removeClass('show');
                                    warningToast.addClass('fade');
                                    warningToast.remove();
                                }, 10000);
                            }
                            editor.setOption("mode", { name: "javascript", json: true });
                            editor.refresh();
                        });

                        // When switching to YAML mode, convert the content to YAML
                        $('#yamlModeBtn').click(function() {
                            try {
                                let currentContent = editor.getValue();
                                let jsonData = JSON.parse(currentContent); // Try parsing it as JSON
                                let yamlContent = jsyaml.dump(jsonData);
                                editor.setValue(yamlContent); // Set it back as formatted YAML
                            } catch (e) {
                                let currentContent = editor.getValue();
                                if (jsyaml.load(currentContent)){
                                    return;
                                } else{
                                    warningToast.find('.toast-body').text("Invalid JSON content:" + e);
                                    $('body').append(warningToast);
                                    warningToast.addClass('show');
                                    setTimeout(function() {
                                        warningToast.removeClass('show');
                                        warningToast.addClass('fade');
                                        warningToast.remove();
                                    }, 10000);

                                }
                                
                            }
                            editor.setOption("mode", "yaml");
                            editor.refresh();
                        });





                        editor.setSize(null, 600); 
                    }
                    editor.setValue(JSON.stringify(data, null, 2));
                    $('#edit_config').modal('show');
                },
                error: function(xhr, status, error) {
                    console.error("Error fetching data:", error);
                    alert("Failed to load configuration data.");
                }
            });
        });

        $('#edit_config').on('shown.bs.modal', function () {
            if (editor) {
                editor.refresh();
            }
        });

        $('#save_configuration').click(function() {
            //const editedData = editor.getValue();
            var formattedJson;
            try{
                var currentContent = editor.getValue();
                var jsonData = jsyaml.load(currentContent); 
                var formattedJson = JSON.stringify(jsonData, null, 2);
            } catch (e){
                formattedJson = editor.getValue();
            }


            const editedData = formattedJson;

            $.ajax({
                url: '/save_config',
                type: 'POST',
                contentType: 'application/json',
                data: editedData,
                success: function(response) {
                    console.log(response);

                    $('body').append(successToast);
                    successToast.addClass('show');
                    setTimeout(function() {
                        successToast.removeClass('show');
                        successToast.addClass('fade');
                        successToast.remove();
                    }, 10000);
                    $('#edit_config').modal('hide');
                },
                error: function(xhr, status, error) {
                    console.error("Error saving data:", xhr);
                    console.error("Error saving data:", xhr.responseJSON.response);
                    console.error("Error saving data:", status);
                    console.error("Error saving data:", error);

                    failedToast.find('.toast-body').text("Error: " + xhr.responseJSON.response);
                    $('body').append(failedToast);
                    failedToast.addClass('show');
                    setTimeout(function() {
                        failedToast.removeClass('show');
                        failedToast.addClass('fade');
                        failedToast.remove();
                    }, 10000);
                }
            });
        });

    });

</script>